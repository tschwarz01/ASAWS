{
	"name": "04-Dedicated Pool Queries",
	"properties": {
		"folder": {
			"name": "Day 01 - Dedicated Pool"
		},
		"content": {
			"query": "/* \nMust load data prior to executing the below SELECT queries\nhttps://microsoftlearning.github.io/DP-500-Azure-Data-Analyst/Instructions/labs/03-Explore-data-warehouse.html\n\ncd ./dp500/Allfiles/03\n$sqlDatabaseName = \"\"\n$synapseWorkspace = \"\"\n$sqlUser = \"\"\nGet-ChildItem \"./data/*.txt\" -File | Foreach-Object {                                                                                                                                           \n\t$file = $_.FullName\n\tWrite-Host \"$file\"\n\t$table = $_.Name.Replace(\".txt\",\"\")\n\tbcp dbo.$table in $file -S \"$synapseWorkspace.sql.azuresynapse.net\" -U $sqlUser -P $sqlPassword -d $sqlDatabaseName -f $file.Replace(\"txt\", \"fmt\") -q -k -E -b 5000\n}\n\n*/\n\n/* Query Fact & Dimension Tables */\n\n SELECT  d.CalendarYear AS Year,\n         SUM(i.SalesAmount) AS InternetSalesAmount\n FROM FactInternetSales AS i\n JOIN DimDate AS d ON i.OrderDateKey = d.DateKey\n GROUP BY d.CalendarYear\n ORDER BY Year;\n\n\n /* Add the month attribute from the time table and re-run */\n\n SELECT  d.CalendarYear AS Year,\n         d.MonthNumberOfYear AS Month,\n         SUM(i.SalesAmount) AS InternetSalesAmount\n FROM FactInternetSales AS i\n JOIN DimDate AS d ON i.OrderDateKey = d.DateKey\n GROUP BY d.CalendarYear, d.MonthNumberOfYear\n ORDER BY Year, Month;\n\n\n/* Query yearly sales by region */\nEXPLAIN \nSELECT  d.CalendarYear AS Year,\n         g.EnglishCountryRegionName AS Region,\n         SUM(i.SalesAmount) AS InternetSalesAmount\n FROM FactInternetSales AS i\n JOIN DimDate AS d ON i.OrderDateKey = d.DateKey\n JOIN DimCustomer AS c ON i.CustomerKey = c.CustomerKey\n JOIN DimGeography AS g ON c.GeographyKey = g.GeographyKey\n GROUP BY d.CalendarYear, g.EnglishCountryRegionName\n ORDER BY Year, Region;\n\n\n /* Include product category and re-run */\n\n  SELECT  d.CalendarYear AS Year,\n         pc.EnglishProductCategoryName AS ProductCategory,\n         g.EnglishCountryRegionName AS Region,\n         SUM(i.SalesAmount) AS InternetSalesAmount\n FROM FactInternetSales AS i\n JOIN DimDate AS d ON i.OrderDateKey = d.DateKey\n JOIN DimCustomer AS c ON i.CustomerKey = c.CustomerKey\n JOIN DimGeography AS g ON c.GeographyKey = g.GeographyKey\n JOIN DimProduct AS p ON i.ProductKey = p.ProductKey\n JOIN DimProductSubcategory AS ps ON p.ProductSubcategoryKey = ps.ProductSubcategoryKey\n JOIN DimProductCategory AS pc ON ps.ProductCategoryKey = pc.ProductCategoryKey\n GROUP BY d.CalendarYear, pc.EnglishProductCategoryName, g.EnglishCountryRegionName\n ORDER BY Year, ProductCategory, Region;\n\n\n /* Query using ranking functions */\n\n  SELECT  g.EnglishCountryRegionName AS Region,\n         ROW_NUMBER() OVER(PARTITION BY g.EnglishCountryRegionName\n                           ORDER BY i.SalesAmount ASC) AS RowNumber,\n         i.SalesOrderNumber AS OrderNo,\n         i.SalesOrderLineNumber AS LineItem,\n         i.SalesAmount AS SalesAmount,\n         SUM(i.SalesAmount) OVER(PARTITION BY g.EnglishCountryRegionName) AS RegionTotal,\n         AVG(i.SalesAmount) OVER(PARTITION BY g.EnglishCountryRegionName) AS RegionAverage\n FROM FactInternetSales AS i\n JOIN DimDate AS d ON i.OrderDateKey = d.DateKey\n JOIN DimCustomer AS c ON i.CustomerKey = c.CustomerKey\n JOIN DimGeography AS g ON c.GeographyKey = g.GeographyKey\n WHERE d.CalendarYear = 2022\n ORDER BY Region;\n\n /* Rank cities per region by total sales amount */\n\n SELECT  g.EnglishCountryRegionName AS Region,\n         g.City,\n         SUM(i.SalesAmount) AS CityTotal,\n         SUM(SUM(i.SalesAmount)) OVER(PARTITION BY g.EnglishCountryRegionName) AS RegionTotal,\n         RANK() OVER(PARTITION BY g.EnglishCountryRegionName\n                     ORDER BY SUM(i.SalesAmount) DESC) AS RegionalRank\n FROM FactInternetSales AS i\n JOIN DimDate AS d ON i.OrderDateKey = d.DateKey\n JOIN DimCustomer AS c ON i.CustomerKey = c.CustomerKey\n JOIN DimGeography AS g ON c.GeographyKey = g.GeographyKey\n GROUP BY g.EnglishCountryRegionName, g.City\n ORDER BY Region;\n\n\n /* COUNT vs Approximate COUNT */\n\n  SELECT d.CalendarYear AS CalendarYear,\n     COUNT(DISTINCT i.SalesOrderNumber) AS Orders\n FROM FactInternetSales AS i\n JOIN DimDate AS d ON i.OrderDateKey = d.DateKey\n GROUP BY d.CalendarYear\n ORDER BY CalendarYear;\n\n\n /* Approximate Count */\n\n  SELECT d.CalendarYear AS CalendarYear,\n     APPROX_COUNT_DISTINCT(i.SalesOrderNumber) AS Orders\n FROM FactInternetSales AS i\n JOIN DimDate AS d ON i.OrderDateKey = d.DateKey\n GROUP BY d.CalendarYear\n ORDER BY CalendarYear;\n\n\n ",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "sqlu3qtrzl",
				"poolName": "sqlu3qtrzl"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}